## Architecture Rules

1. Storage lives ONLY in VaultStorage.sol
2. Logic contracts NEVER declare state
3. Constants live in Constants.sol
4. StrategyRegistry does NOT rebalance
5. RebalanceManager does NOT move funds
6. Strategies NEVER touch vault storage
7. Adapters NEVER calculate profit


contracts/
â”‚
â”œâ”€â”€ vault/
â”‚   â”œâ”€â”€ BaseVault.sol
â”‚   â”‚   # Main user-facing vault (ERC4626)
â”‚   â”‚   # Owns deposits, withdrawals, shares
â”‚   â”‚   # NO strategy math, NO rebalancing math
â”‚   â”‚   # Reads from Storage + calls Managers
â”‚
â”‚   â”œâ”€â”€ VaultStorage.sol
â”‚   â”‚   # ðŸ”’ SINGLE SOURCE OF TRUTH FOR STORAGE
â”‚   â”‚   # ALL state variables live here
â”‚   â”‚   # NEVER put logic here
â”‚   â”‚   # Almost never changes after deployment
â”‚
â”‚   â”œâ”€â”€ StrategyRegistry.sol
â”‚   â”‚   # Registers strategies & debt ratios
â”‚   â”‚   # Tracks per-strategy accounting
â”‚   â”‚   # NO rebalance execution
â”‚   â”‚   # NO ERC4626 logic
â”‚
â”‚   â”œâ”€â”€ RebalanceManager.sol
â”‚   â”‚   # Pure logic for rebalance decisions
â”‚   â”‚   # Computes deviations, targets
â”‚   â”‚   # NEVER declares storage
â”‚   â”‚   # ONLY reads from StrategyRegistry / VaultStorage
â”‚
â”‚   â”œâ”€â”€ WithdrawManager.sol
â”‚   â”‚   # Handles withdrawals & liquidation order
â”‚   â”‚   # Greedy / queue-based withdrawal logic
â”‚   â”‚   # NO deposits, NO strategy registration
â”‚
â”‚   â””â”€â”€ EmergencyManager.sol
â”‚       # Emergency shutdown logic
â”‚       # Revokes strategies, pauses actions
â”‚       # Small & isolated for safety
â”‚
â”œâ”€â”€ strategies/
â”‚   â”œâ”€â”€ BaseStrategy.sol
â”‚   â”‚   # Abstract strategy template
â”‚   â”‚   # Defines hooks: harvest, withdraw, report
â”‚   â”‚   # NO vault storage
â”‚
â”‚   â”œâ”€â”€ adapters/
â”‚   â”‚   â”œâ”€â”€ AaveAdapter.sol
â”‚   â”‚   â”‚   # Protocol-specific interaction
â”‚   â”‚   â”‚   # Supply, withdraw, claim rewards
â”‚   â”‚   â”‚   # NO accounting logic
â”‚   â”‚   â”‚   # Easy to replace or upgrade
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ UniswapAdapter.sol
â”‚   â”‚   â””â”€â”€ CurveAdapter.sol
â”‚
â”‚   â””â”€â”€ strategies/
â”‚       â”œâ”€â”€ AaveStrategy.sol
â”‚       â”‚   # Strategy using AaveAdapter
â”‚       â”‚   # Computes yield, risk score
â”‚       â”‚   # Reports gains/losses to vault
â”‚       â”‚
â”‚       â”œâ”€â”€ UniV3Strategy.sol
â”‚       â””â”€â”€ RWAStrategy.sol
â”‚
â”œâ”€â”€ interfaces/
â”‚   â”œâ”€â”€ IStrategy.sol
â”‚   â”‚   # Strategy â†’ Vault interface
â”‚   â”‚   # harvest(), withdraw(), estimatedAPY()
â”‚
â”‚   â”œâ”€â”€ IVault.sol
â”‚   â”‚   # Vault interface for strategies
â”‚
â”‚   â”œâ”€â”€ IYieldOracle.sol
â”‚   â”‚   # External APY / risk oracle
â”‚
â”‚   â””â”€â”€ IAdapter.sol
â”‚       # Standard adapter interface
â”‚
â”œâ”€â”€ libraries/
â”‚   â”œâ”€â”€ Math.sol
â”‚   â”‚   # All math helpers (BPS, ratios)
â”‚   â”‚   # NO storage
â”‚
â”‚   â”œâ”€â”€ DebtMath.sol
â”‚   â”‚   # Strategy debt limit calculations
â”‚   â”‚   # Used by registry + rebalance manager
â”‚
â”‚   â””â”€â”€ SafeCast.sol
â”‚
â”œâ”€â”€ oracles/
â”‚   â”œâ”€â”€ YieldOracle.sol
â”‚   â”‚   # Calculates APY & risk
â”‚   â”‚   # Offchain or hybrid logic
â”‚
â”‚   â””â”€â”€ MockYieldOracle.sol
â”‚
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ Constants.sol
â”‚   â”‚   # MAX_BPS, MAX_STRATEGIES
â”‚   â”‚   # ONLY constants
â”‚   â”‚   # Imported everywhere
â”‚
â”‚   â””â”€â”€ Roles.sol
â”‚       # Role identifiers & access helpers
â”‚
â”œâ”€â”€ mocks/
â”‚   â”œâ”€â”€ MockERC20.sol
â”‚   â”œâ”€â”€ MockStrategy.sol
â”‚   â””â”€â”€ MockAdapter.sol
â”‚
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ invariants/
â”‚   â”‚   â”œâ”€â”€ VaultInvariant.t.sol
â”‚   â”‚   â”‚   # totalAssets >= totalDebt
â”‚   â”‚   â”‚   # sum(strategyDebt) == vault.totalDebt
â”‚   â”‚
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ StrategyRegistry.t.sol
â”‚   â”‚   â”œâ”€â”€ RebalanceManager.t.sol
â”‚   â”‚   â””â”€â”€ WithdrawManager.t.sol
â”‚
â”‚   â””â”€â”€ integration/
â”‚       â”œâ”€â”€ FullLifecycle.t.sol
â”‚       â””â”€â”€ EmergencyScenario.t.sol
â”‚
â””â”€â”€ README.md
    # Architecture overview
    # Invariants
    # Threat model
