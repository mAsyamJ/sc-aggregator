# Modular Yield Vault Architecture

This repository implements a **strictly modular yield vault system** with hard separation between
storage, logic, strategies, adapters, and oracles.

The architecture is intentionally opinionated to **prevent accounting bugs, unsafe upgrades, and
cross-layer coupling**.

---

## Architecture Rules

These rules are **non-negotiable**. Violating any of them is considered a critical design flaw.

1. Storage lives **ONLY** in `VaultStorage.sol`
2. Logic contracts **NEVER** declare state
3. Constants live in `Constants.sol`
4. `StrategyRegistry` does **NOT** rebalance
5. `RebalanceManager` does **NOT** move funds
6. Strategies **NEVER** touch vault storage
7. Adapters **NEVER** calculate profit or losses

---

## Repository Structure

```text
contracts/
â”‚
â”œâ”€â”€ vault/
â”‚   â”œâ”€â”€ BaseVault.sol
â”‚   â”‚   Main user-facing ERC4626 vault
â”‚   â”‚   - Handles deposits, withdrawals, shares
â”‚   â”‚   - NO strategy math
â”‚   â”‚   - NO rebalancing math
â”‚   â”‚   - Reads from VaultStorage
â”‚   â”‚   - Delegates logic to managers
â”‚
â”‚   â”œâ”€â”€ VaultStorage.sol
â”‚   â”‚   ðŸ”’ Single source of truth for storage
â”‚   â”‚   - ALL state variables live here
â”‚   â”‚   - NO logic
â”‚   â”‚   - Almost never changes after deployment
â”‚
â”‚   â”œâ”€â”€ StrategyRegistry.sol
â”‚   â”‚   - Registers strategies
â”‚   â”‚   - Stores debt ratios
â”‚   â”‚   - Tracks per-strategy accounting
â”‚   â”‚   - NO rebalance execution
â”‚   â”‚   - NO ERC4626 logic
â”‚
â”‚   â”œâ”€â”€ RebalanceManager.sol
â”‚   â”‚   - Pure rebalance decision logic
â”‚   â”‚   - Computes deviations and target allocations
â”‚   â”‚   - NEVER declares storage
â”‚   â”‚   - Reads from StrategyRegistry and VaultStorage
â”‚
â”‚   â”œâ”€â”€ WithdrawManager.sol
â”‚   â”‚   - Handles withdrawals
â”‚   â”‚   - Greedy / queue-based liquidation
â”‚   â”‚   - NO deposits
â”‚   â”‚   - NO strategy registration
â”‚
â”‚   â””â”€â”€ EmergencyManager.sol
â”‚       - Emergency shutdown logic
â”‚       - Revokes strategies
â”‚       - Pauses vault actions
â”‚       - Small and isolated for safety
â”‚
â”œâ”€â”€ strategies/
â”‚   â”œâ”€â”€ BaseStrategy.sol
â”‚   â”‚   Abstract strategy template
â”‚   â”‚   - Defines hooks: harvest, withdraw, report
â”‚   â”‚   - NO vault storage access
â”‚
â”‚   â”œâ”€â”€ adapters/
â”‚   â”‚   â”œâ”€â”€ AaveAdapter.sol
â”‚   â”‚   â”‚   - Protocol-specific interactions
â”‚   â”‚   â”‚   - supply, withdraw, claim rewards
â”‚   â”‚   â”‚   - NO accounting logic
â”‚   â”‚   â”‚   - Easily replaceable or upgradeable
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ UniswapAdapter.sol
â”‚   â”‚   â””â”€â”€ CurveAdapter.sol
â”‚
â”‚   â””â”€â”€ strategies/
â”‚       â”œâ”€â”€ AaveStrategy.sol
â”‚       â”‚   - Uses AaveAdapter
â”‚       â”‚   - Computes yield and risk score
â”‚       â”‚   - Reports gains and losses to the vault
â”‚       â”‚
â”‚       â”œâ”€â”€ UniV3Strategy.sol
â”‚       â””â”€â”€ RWAStrategy.sol
â”‚
â”œâ”€â”€ interfaces/
â”‚   â”œâ”€â”€ IStrategy.sol
â”‚   â”‚   Strategy â†’ Vault interface
â”‚   â”‚   - harvest()
â”‚   â”‚   - withdraw()
â”‚   â”‚   - estimatedAPY()
â”‚
â”‚   â”œâ”€â”€ IVault.sol
â”‚   â”‚   Vault interface exposed to strategies
â”‚
â”‚   â”œâ”€â”€ IYieldOracle.sol
â”‚   â”‚   External APY / risk oracle interface
â”‚
â”‚   â””â”€â”€ IAdapter.sol
â”‚       Standard adapter interface
â”‚
â”œâ”€â”€ libraries/
â”‚   â”œâ”€â”€ Math.sol
â”‚   â”‚   - Basis point math
â”‚   â”‚   - Ratio helpers
â”‚   â”‚   - NO storage
â”‚
â”‚   â”œâ”€â”€ DebtMath.sol
â”‚   â”‚   - Strategy debt limit calculations
â”‚   â”‚   - Used by StrategyRegistry and RebalanceManager
â”‚
â”‚   â””â”€â”€ SafeCast.sol
â”‚
â”œâ”€â”€ oracles/
â”‚   â”œâ”€â”€ YieldOracle.sol
â”‚   â”‚   - Computes APY and risk scores
â”‚   â”‚   - Off-chain or hybrid logic
â”‚
â”‚   â””â”€â”€ MockYieldOracle.sol
â”‚
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ Constants.sol
â”‚   â”‚   - MAX_BPS
â”‚   â”‚   - MAX_STRATEGIES
â”‚   â”‚   - Global protocol constants
â”‚
â”‚   â””â”€â”€ Roles.sol
â”‚       - Role identifiers
â”‚       - Access control helpers
â”‚
â”œâ”€â”€ mocks/
â”‚   â”œâ”€â”€ MockERC20.sol
â”‚   â”œâ”€â”€ MockStrategy.sol
â”‚   â””â”€â”€ MockAdapter.sol
â”‚
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ invariants/
â”‚   â”‚   â”œâ”€â”€ VaultInvariant.t.sol
â”‚   â”‚   â”‚   Enforced invariants:
â”‚   â”‚   â”‚   - totalAssets >= totalDebt
â”‚   â”‚   â”‚   - sum(strategyDebt) == vault.totalDebt
â”‚   â”‚
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ StrategyRegistry.t.sol
â”‚   â”‚   â”œâ”€â”€ RebalanceManager.t.sol
â”‚   â”‚   â””â”€â”€ WithdrawManager.t.sol
â”‚   â”‚
â”‚   â””â”€â”€ integration/
â”‚       â”œâ”€â”€ FullLifecycle.t.sol
â”‚       â””â”€â”€ EmergencyScenario.t.sol
â”‚
â””â”€â”€ README.md
